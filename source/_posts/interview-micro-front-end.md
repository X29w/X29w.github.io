---
title: interview-micro-front-end
date: 2024-05-30 23:02:59
cover: https://th.bing.com/th/id/OIP.9l6G_aOy7FojOtbwHddPJgHaEL?w=286&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7
tags:
---

# 微前端
## 微前端概念详细解析

微前端（Micro Frontend）是一种现代Web开发架构理念，它借鉴了微服务的思想，将原本庞大的前端应用拆分为多个小型、独立可部署的微应用集合。每个微应用都是一个完整的功能单元，拥有自己的业务逻辑、UI组件、数据管理、路由系统甚至开发团队。这些微应用可以独立开发、测试、部署，最终通过某种机制集成到同一个宿主应用中，共同构成用户面前的完整产品界面。

**关键技术点**：
- **模块化与解耦**：微前端的核心在于高度模块化和业务解耦，确保每个微应用可以独立演进。
- **通信机制**：需要一套有效的跨微应用通信方案，以便微应用间能够相互通信和数据共享。
- **资源加载与隔离**：动态加载微应用资源，同时确保CSS、JavaScript的隔离，避免全局污染。
- **路由管理**：如何处理微应用内部路由与宿主应用路由的集成，保证良好的用户体验。
- **部署策略**：支持独立部署，每个微应用可以按需更新，减少整体部署风险。
- **技术栈无关**： 不同的微前端应用可以使用不同的技术栈，这为使用新技术、升级旧技术提供了可能。

- **并行开发**： 因为微前端应用是独立的，所以多个团队可以并行开发不同的应用，无需担心相互影响。


## qiankun 微前端框架工作原理深度剖析

qiankun 是一个流行的微前端实现框架，它基于single-spa并进行了大量优化和封装，提供了更加简洁的API和强大的功能。其工作原理可以细致分为以下几个方面：

**应用容器化**：qiankun 通过在宿主应用中创建一个或多个“沙箱”环境（容器），为每个子应用提供独立的运行空间。
   
**动态加载与挂载**：利用动态导入（`import()`）API，qiankun 在需要时异步加载子应用的入口文件。加载完成后，通过特定的生命周期钩子（如`bootstrap`, `mount`, `unmount`）来控制子应用的初始化、挂载和卸载过程。

**沙箱机制**：为了防止JavaScript全局变量冲突和CSS样式污染，qiankun 实现了沙箱机制，通过修改全局对象的原型链或代理等方式，为每个子应用创造独立的运行环境。

**路由与状态管理**：qiankun 支持多种路由集成方案，包括直接使用宿主应用的路由系统、子应用自管理路由或两者的混合模式。同时，通过`actions`和`events`机制提供跨应用状态共享和通信能力。

## 解决JS污染问题

>qiankun 的 js 沙箱机制主要是通过代理 window 对象来实现的，它可以有效地隔离子应用的全局变量，防止子应用之间的全局变量污染。然而，这种机制并不能解决所有的 js 污染问题。例如，如果我们使用 onclick 或 addEventListener 给 <body> 添加了一个点击事件，js 沙箱并不能消除它的影响。

qiankun 的沙箱机制是解决JS污染的关键。它通过以下方式实现隔离：
- **全局变量代理**：为每个子应用创建一个影子全局对象，代理真实全局对象，使子应用的全局变量变更不直接影响宿主或其他子应用。
- **事件委托与代理**：对DOM事件监听进行代理，确保事件的注册和触发都在子应用内部完成，避免全局事件污染。
- **自定义元素封装**：鼓励使用Web Components或类似技术封装子应用内的组件，确保CSS和JS逻辑的隔离。

## CSS隔离机制与挑战

qiankun 提供了多种CSS隔离方案：
- **Scoped CSS**: 利用Webpack的CSS Modules或Vue、React等框架自带的Scoped CSS特性，限制样式的作用范围。
- **Shadow DOM**: 对于支持的浏览器，利用Shadow DOM天然的样式隔离能力。
- **CSS-in-JS**: 使用样式注入库如styled-components，确保样式与组件紧密绑定。

缺点包括：增加了开发复杂度、可能的浏览器兼容性问题、以及对开发者技能的要求提高。替代方案包括使用BEM等命名约定，或引入第三方CSS隔离库如css-modules-require-hook。

## 父子项目通信

在Qiankun微前端框架中，父子项目（主应用与子应用）之间的通信是通过几种内置机制来实现的，确保不同子应用之间或子应用与主应用之间能够有效地共享数据或触发事件。以下是Qiankun支持的一些通信方式：

1. **Actions**:
   Qiankun 提供了一种名为 Actions 的通信方式，这是一种基于发布/订阅模式的通信机制。主应用可以定义一系列actions，并且子应用可以通过这些actions来触发主应用中的逻辑，反之亦然。例如，主应用可以提供一个action用于改变全局主题，子应用则可以调用这个action来改变整个应用的主题。

2. **Props**:
   当主应用装载子应用时，可以通过props的形式向子应用传递数据。这种方式类似于React中的props传递，适用于一次性传递初始化数据的场景。

3. **Global State (全局状态管理)**:
   Qiankun 支持全局状态管理，允许主应用和子应用共享一个状态管理实例（如Vuex）。通过这种方式，任何应用都可以修改和响应全局状态的变化。

4. **Event Bus**:
   虽然不是Qiankun直接提供的功能，但你可以在主应用中设置一个全局的Event Bus（事件总线），允许主应用和子应用通过发布和订阅事件来进行通信。

5. **LocalStorage/SessionStorage**:
   利用浏览器的本地存储或会话存储也是一种实现跨应用通信的方式，但这种方式更多用于非实时或持久化的需求。

6. **通过路由参数**:
   在URL中携带参数，使得子应用通过监听路由变化来获取信息，这种方式适用于较小的数据传输或导航相关的通信。

使用Qiankun进行父子项目通信的基本步骤通常包括：
- **主应用设置**：在主应用中初始化Qiankun，并注册子应用，定义通信接口（如Actions）或全局状态。
- **子应用适配**：子应用需按照Qiankun的要求进行微应用的导出配置，并在需要的地方调用主应用暴露的通信API。
- **通信实现**：根据通信需求选择合适的通信方式，如通过Actions发送请求、监听全局状态变更或通过props接收数据。

例如，使用Actions通信的一个简单示例：
- 在主应用中定义actions：
  ```javascript
  import { initGlobalState } from 'qiankun';

  const actions = initGlobalState({
    theme: 'light',
    setTheme(theme) {
      this.theme = theme;
    },
  });
  ```
- 子应用中调用actions：
  ```javascript
  // 在子应用内，通过生命周期或自定义方法调用
  window.__POWERED_BY_QIANKUN__ && actions.setTheme('dark');
  ```

确保在进行通信设计时，根据实际业务需求选择最合适的通信策略，以保持代码的清晰性和维护性。

### 实现一套通信机制

如果要自定义一套通信机制，可以参考以下步骤：

**建立消息中心**：设计一个全局的消息中心，负责事件的注册、分发与注销。可以是一个单例模式的对象，确保全局唯一。

**事件注册与触发**：允许应用注册特定类型的事件及其处理器，同时提供一个触发事件的方法。事件可以携带数据，处理器根据事件类型执行相应逻辑。

**消息格式与协议**：定义统一的消息格式和通信协议，确保不同来源的消息可以被正确识别和处理，比如使用JSON作为数据载体，规定消息头包含事件类型、来源等信息。

**异步支持**：考虑异步场景，确保处理器可以是异步函数，并且支持Promise或async/await，便于处理复杂的业务逻辑。

**错误处理与日志**：内置错误捕获和日志记录机制，对于未能正确处理的事件或异常，提供合理的错误反馈和记录。

**性能与优化**：考虑通信的性能影响，比如批量处理事件、事件节流/防抖等策略，减少不必要的渲染和计算。

通过这样的设计，可以构建一个灵活、高效且易于维护的通信机制，满足微前端架构下不同子应用间的协作需求。

## 子项目之间通信
在Qiankun微前端框架中，子项目（子应用）之间的通信并不直接由Qiankun提供开箱即用的解决方案，因为Qiankun主要关注于主应用与子应用之间的管理和通信。然而，子应用之间通信可以通过以下几种策略来实现：

**通过主应用中转**：
   利用Qiankun提供的全局状态管理或Actions，可以间接实现子应用间的通信。一个子应用可以更新全局状态或触发一个Action，而其他子应用则可以监听这些状态变化或Action，从而实现间接通信。

**Event Bus**：
   创建一个中心化的Event Bus（事件总线），无论是放在主应用还是一个专门的公共服务子应用中，然后让所有子应用通过这个Event Bus发布和订阅事件。这样，任意子应用都可以发出事件，其他感兴趣的子应用可以监听并作出响应。

**Custom Events与PostMessage**：
   如果子应用是通过IFrame或者其他跨域方式集成的，可以使用`window.postMessage`来实现跨上下文的通信。一个子应用可以通过`postMessage`发送消息到另一个子应用所在窗口，后者通过监听`message`事件来接收这些消息。

**Shared Services或微服务**：
   构建一个共享的服务层或微服务，子应用通过调用这些服务来交换数据或触发操作。这要求后端支持或者建立一个轻量级的服务端来处理这些交互。

**使用第三方状态管理库**：
   如果所有子应用都集成了如Redux、Vuex等状态管理库，可以通过某种方式共享一个Store实例，尽管这在技术上较复杂，需要特别的配置来桥接各个子应用的Store。

**LocalStorage/SessionStorage**：
   虽然不够实时，但存储在本地或会话存储中的数据可以作为一种“通信”的方式，一个子应用写入数据，另一个子应用通过监听Storage事件或轮询来读取这些变化。

每种方法都有其适用场景和限制，选择最合适的方式取决于你的具体需求、子应用的技术栈以及对性能、实时性、复杂度的考量。在实践中，通常需要结合Qiankun的特性和其他Web通信技术来定制化实现子应用间的通信方案。

## 路由模式整合

解决子应用路由模式不一致的问题，qiankun 提倡以下策略：
- **统一模式**：推荐所有子应用采用同一路由模式（通常是History模式），并在宿主应用层面做统一处理。
- **适配层**：在宿主应用中实现路由模式适配逻辑，比如通过URL重写或路由中间件，确保子应用的路由可以正常工作。

## 组件共享方案
- **父子项目间的组件共享**：主项目加载时，将组件挂载到全局对象（如window）上，在子项目中直接注册使用该组件。
- **npm包共享**：将共享组件封装为npm包，各子应用按需安装使用。
- **微应用作为组件库**：将某个微应用专门设计为组件库微应用，其他应用动态加载其组件。
- **远程组件加载**：利用Web Components或前端微服务技术，实现跨项目组件的远程加载和使用。

## 依赖复用方案
除了npm包，qiankun 本身并不直接提供依赖复用的机制，但可以通过以下方式间接实现：
- 在使用webpack构建的子项目中，要实现复用公共依赖，需要配置webpack的externals，将公共依赖指定为外部依赖，不打包进子项目的代码中。


- 子项目之间的依赖复用可以通过保证依赖的URL一致来实现。如果多个子项目都使用同一份CDN文件，加载时会先从缓存读取，避免重复加载。


- 子项目复用主项目的依赖可以通过给子项目的index.html中的公共依赖的script和link标签添加自定义属性ignore来实现。在qiankun运行子项目时，qiankun会忽略这些带有ignore属性的依赖，子项目独立运行时仍然可以加载这些依赖。


- 在使用qiankun微前端框架时，可能会出现子项目之间和主项目之间的全局变量冲突的问题。这是因为子项目不配置externals时，子项目的全局Vue变量不属于window对象，而qiankun在运行子项目时会先找子项目的window，再找父项目的window，导致全局变量冲突。


解决全局变量冲突的方案有三种：

- 方案一是在注册子项目时，在beforeLoad钩子函数中处理全局变量，将子项目的全局Vue变量进行替换，以解决子项目独立运行时的全局变量冲突问题。
- 方案二是通过主项目将依赖通过props传递给子项目，子项目在独立运行时使用传递过来的依赖，避免与主项目的全局变量冲突。
- 方案三是修改主项目和子项目的依赖名称，使它们不会相互冲突，从而避免全局变量冲突的问题。


## 资源加载机制（import-html-entry）

>qiankun import-html-entry 是qiankun 框架中用于加载子应用的 HTML 入口文件的工具函数。它提供了一种方便的方式来动态加载和解析子应用的 HTML 入口文件，并返回一个可以加载子应用的 JavaScript 模块。
`import-html-entry`是qiankun中用于加载子应用HTML入口的实用工具。其工作流程如下：
- 加载 HTML 入口文件：import-html-entry 会通过创建一个 <link> 标签来加载子应用的 HTML 入口文件。这样可以确保子应用的资源得到正确加载，并在加载完成后进行处理。

- 解析 HTML 入口文件：一旦 HTML 入口文件加载完成，import-html-entry 将解析该文件的内容，提取出子应用的 JavaScript 和 CSS 资源的 URL。

- 动态加载 JavaScript 和 CSS 资源：import-html-entry 使用动态创建 <script> 和 <link> 标签的方式，按照正确的顺序加载子应用的 JavaScript 和 CSS 资源。

- 创建沙箱环境：在加载子应用的 JavaScript 资源时，import-html-entry 会创建一个沙箱环境（sandbox），用于隔离子应用的全局变量和运行环境，防止子应用之间的冲突和污染。

- 返回子应用的入口模块：最后，import-html-entry 返回一个可以加载子应用的 JavaScript 模块。这个模块通常是一个包含子应用初始化代码的函数，可以在主应用中调用以加载和启动子应用。



## qiankun的优缺点
- 优点
    - 降低了应用改造的成本，通过html entry的方式引入子应用；
    - 提供了完备的沙箱方案，包括js沙箱和css沙箱；
    - 支持静态资源预加载能力。

- 缺点
    - 适配成本较高，包括工程化、生命周期、静态资源路径、路由等方面的适配；
    - css沙箱的严格隔离可能引发问题，js沙箱在某些场景下执行性能下降；
    - 无法同时激活多个子应用，不支持子应用保活；
    - 不支持vite等esmodule脚本运行。
